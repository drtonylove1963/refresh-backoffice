{% extends "base.html" %}

{% block content %}
<div class="admin-container">
    <div class="sidebar">
        <div class="logo-section mb-4">
            <img src="{{ url_for('static', filename='images/refresh_church_primary_full_color.png') }}" alt="Refresh Church" class="brand-logo light-mode" style="width: 180px; height: auto;">
            <img src="{{ url_for('static', filename='images/refresh_church_primary_white.png') }}" alt="Refresh Church" class="brand-logo dark-mode" style="width: 180px; height: auto;">
        </div>
        <div class="quick-actions mt-4">
            <h5 class="mb-3">Quick Actions</h5>
            <div class="d-grid gap-2">
                <a href="{{ url_for('member.member_list') }}" class="btn btn-outline-primary">
                    <i class="bi bi-people"></i> Manage Members
                </a>
                <a href="{{ url_for('admin.email_templates') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-envelope"></i> Email Templates
                </a>
            </div>
        </div>
        <div class="mt-auto pt-4">
            <a href="{{ url_for('admin.logout') }}" class="btn btn-outline-danger w-100">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="top-nav">
            <div class="nav-links">
                <a href="{{ url_for('admin.dashboard') }}">Dashboard</a>
                <a href="{{ url_for('member.member_list') }}">People</a>
                <a href="{{ url_for('admin.planned_visits') }}">Planned Visits</a>
                <a href="{{ url_for('admin.email_templates') }}">Email</a>
                <a href="{{ url_for('admin.test_page') }}" class="active">Test</a>
                <a href="#">Settings</a>
            </div>
        </div>

        <div class="main-content">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Breeze API Member Data Test</h5>
                            </div>
                            <div class="card-body">
                                <form id="memberForm" class="mb-4">
                                    <div class="mb-3">
                                        <label for="memberSelect" class="form-label">Select Member</label>
                                        <select class="form-select" id="memberSelect" required>
                                            <option value="">Choose a member...</option>
                                            {% for member in members %}
                                            <option value="{{ member.breeze_id }}">{{ member.full_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="btn-group">
                                        <button type="submit" class="btn btn-primary">
                                            Fetch Breeze Data
                                        </button>
                                        <button type="button" id="fetchProfileFields" class="btn btn-secondary">
                                            Fetch Profile Fields
                                        </button>
                                    </div>
                                </form>
                                
                                <div id="apiResponse" class="d-none">
                                    <h6>API Response:</h6>
                                    <div class="api-response p-3">
                                        <h6>API Response Fields:</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover" id="apiFieldsTable">
                                                <thead>
                                                    <tr>
                                                        <th>Field Name</th>
                                                        <th>Value</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="responseData">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Utility function to create table rows for API response data
function createTableRows(data, tbody, prefix = '') {
    tbody.innerHTML = ''; // Clear previous data
    for (const [key, value] of Object.entries(data)) {
        const row = document.createElement('tr');
        const fieldName = document.createElement('td');
        const fieldValue = document.createElement('td');
        
        fieldName.textContent = prefix + key;
        
        if (value === null) {
            fieldValue.textContent = 'null';
            fieldValue.classList.add('text-muted');
        } else if (typeof value === 'object') {
            fieldValue.textContent = 'Object';
            fieldValue.classList.add('text-primary');
            createTableRows(value, tbody, `${prefix}${key}.`);
        } else {
            fieldValue.textContent = value;
        }
        
        row.appendChild(fieldName);
        row.appendChild(fieldValue);
        tbody.appendChild(row);
    }
}

// Debounce function to prevent rapid API calls
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Handle member data fetch
document.getElementById('memberForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const memberSelect = document.getElementById('memberSelect');
    const responseDiv = document.getElementById('apiResponse');
    const responseData = document.getElementById('responseData');
    const breezeId = memberSelect.value;
    
    if (!breezeId) {
        alert('Please select a member');
        return;
    }

    try {
        const response = await fetch(`/admin/breeze-data/${breezeId}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        const data = await response.json();
        responseDiv.classList.remove('d-none');
        createTableRows(data, responseData);
    } catch (error) {
        console.error('Error:', error);
        alert('Error fetching member data');
    }
});

// Handle profile fields fetch with debouncing
document.getElementById('fetchProfileFields').addEventListener('click', debounce(async function() {
    const responseDiv = document.getElementById('apiResponse');
    const responseData = document.getElementById('responseData');
    
    try {
        const response = await fetch('/admin/breeze-profile-fields', {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        const data = await response.json();
        responseDiv.classList.remove('d-none');
        createTableRows(data, responseData);
    } catch (error) {
        console.error('Error:', error);
        alert('Error fetching profile fields');
    }
}, 500)); // 500ms debounce delay
</script>
{% endblock %}